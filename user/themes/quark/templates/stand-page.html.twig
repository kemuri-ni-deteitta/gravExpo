{% extends 'partials/base.html.twig' %}

{% block content %}
{% set grid_size = theme_var('grid-size') %}

<section class="section stand-page">
    <section class="container {{ grid_size }}">
        <div class="columns">
            <div class="column col-12">
                <div class="content">
                    {{ content|raw }}
                </div>
                
                {% if page.header.gallery %}
                <div class="portfolio-section">
                    <div class="gallery-header">
                        <h2>Примеры работ</h2>
                        <p><a href="/portfolio" class="portfolio-link">Смотреть все проекты в портфолио →</a></p>
                    </div>
                    
                    <div class="portfolio-gallery">
                        <div class="portfolio-grid">
                            {% set gallery_id = md5(page.url) %}
                            {% for gallery_item in page.header.gallery %}
                                <div class="portfolio-item">
                                    {% set project_images = [] %}
                                    {% set main_image = null %}
                                    {% set title = gallery_item.title ?: 'Проект' %}
                                    {% set desc = gallery_item.desc ?: '' %}
                                    
                                    {# Ensure all metadata fields have default values #}
                                    {% set construction_area = gallery_item.construction_area ?: '' %}
                                    {% set exhibition_name = gallery_item.exhibition_name ?: '' %}
                                    {% set company_name = gallery_item.company_name ?: '' %}
                                    {% set project_year = gallery_item.project_year ?: '' %}
                                    
                                    {# Handle multiple images structure #}
                                    {% if gallery_item.images %}
                                        {% for img_item in gallery_item.images %}
                                            {% set img_obj = null %}
                                            
                                            {# Check for uploaded image #}
                                            {% if img_item.image_upload %}
                                                {% for filepath, filedata in img_item.image_upload %}
                                                    {% if not img_obj and filedata.name %}
                                                        {% set img_obj = page.media[filedata.name] %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                            
                                            {% if img_obj %}
                                                {% set img_data = {
                                                    'image': img_obj,
                                                    'caption': img_item.caption ?: '',
                                                    'is_main': img_item.is_main ?: false
                                                } %}
                                                {% set project_images = project_images|merge([img_data]) %}
                                                
                                                {# Set main image #}
                                                {% if img_item.is_main and not main_image %}
                                                    {% set main_image = img_obj %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    
                                    {# Legacy single image handling if no images found #}
                                    {% if project_images|length == 0 %}
                                        {% set item_image = null %}
                                        
                                        {# Check for uploaded image first #}
                                        {% if gallery_item.image_upload %}
                                            {% for filepath, filedata in gallery_item.image_upload %}
                                                {% if not item_image and filedata.name %}
                                                    {% set item_image = page.media[filedata.name] %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                        
                                        {# If no uploaded image, check for image_name #}
                                        {% if not item_image and gallery_item.image_name %}
                                            {% set item_image = page.media[gallery_item.image_name] %}
                                        {% endif %}
                                        
                                        {# Fallback to old image field #}
                                        {% if not item_image and gallery_item.image %}
                                            {% set item_image = page.media[gallery_item.image] %}
                                        {% endif %}
                                        
                                        {% if item_image %}
                                            {% set img_data = {
                                                'image': item_image,
                                                'caption': desc,
                                                'is_main': true
                                            } %}
                                            {% set project_images = [img_data] %}
                                            {% set main_image = item_image %}
                                        {% endif %}
                                    {% endif %}
                                    
                                    {# Use first image as main if no main image specified #}
                                    {% if not main_image and project_images|length > 0 %}
                                        {% set main_image = project_images[0].image %}
                                    {% endif %}
                                    
                                    {% if main_image and project_images|length > 0 %}
                                        {% set thumb_width = 400 %}
                                        {% set thumb_height = 300 %}
                                        
                                        <div class="portfolio-card">
                                            <div class="portfolio-image">
                                                {# Main image with multiple images support #}
                                                <a href="{{ main_image.url }}" 
                                                   class="glightbox" 
                                                   data-gallery="gallery-{{ gallery_id }}-{{ loop.index }}"
                                                   data-title="{{ title }}"
                                                   data-description="{{ desc }}">
                                                    <img src="{{ main_image.cropZoom(thumb_width, thumb_height).url }}" 
                                                         alt="{{ title }}" 
                                                         title="{{ title }}">
                                                </a>
                                                
                                                {# Image counter if multiple images #}
                                                {% if project_images|length > 1 %}
                                                    <div class="image-counter">
                                                        <i class="fa fa-camera"></i> {{ project_images|length }}
                                                    </div>
                                                {% endif %}
                                                
                                                {# Hidden images for lightbox #}
                                                {% if project_images|length > 1 %}
                                                    {% for img_data in project_images %}
                                                        {% if img_data.image != main_image %}
                                                            <a href="{{ img_data.image.url }}" 
                                                               class="glightbox hidden-lightbox-item" 
                                                               data-gallery="gallery-{{ gallery_id }}-{{ loop.parent.loop.index }}"
                                                               data-title="{{ img_data.caption ?: title }}"
                                                               data-description="{{ img_data.caption }}"></a>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                            
                                            <div class="portfolio-info">
                                                <h4 class="portfolio-title">{{ title }}</h4>
                                                
                                                <div class="portfolio-metadata">
                                                    {% if construction_area %}
                                                        <div class="metadata-item">
                                                            <span class="label">Площадь:</span>
                                                            <span class="value">{{ construction_area }}</span>
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {% if exhibition_name %}
                                                        <div class="metadata-item">
                                                            <span class="label">Выставка:</span>
                                                            <span class="value">{{ exhibition_name }}</span>
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {% if company_name %}
                                                        <div class="metadata-item">
                                                            <span class="label">Клиент:</span>
                                                            <span class="value">{{ company_name }}</span>
                                                        </div>
                                                    {% endif %}
                                                    
                                                    {% if project_year %}
                                                        <div class="metadata-item">
                                                            <span class="label">Год:</span>
                                                            <span class="value">{{ project_year }}</span>
                                                        </div>
                                                    {% endif %}
                                                </div>
                                                
                                                {% if desc %}
                                                    <div class="portfolio-description">{{ desc }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </section>
</section>
{% endblock %}

{% block stylesheets %}
{{ parent() }}
{% set portfolio_styles %}
.portfolio-section {
    margin: 30px 0;
}

.gallery-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 2px solid #f8f9fa;
}

.gallery-header h2 {
    margin: 0;
    font-size: 28px;
    color: #333;
    font-weight: 600;
}

.portfolio-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 500;
    font-size: 14px;
    transition: color 0.3s ease;
}

.portfolio-link:hover {
    color: #0056b3;
    text-decoration: underline;
}

.portfolio-gallery {
    margin: 20px 0;
}

.portfolio-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 30px;
    margin-top: 30px;
}

.portfolio-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s ease;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.portfolio-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.portfolio-image {
    position: relative;
    overflow: hidden;
    aspect-ratio: 4/3;
}

.portfolio-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
}

.portfolio-image:hover img {
    transform: scale(1.05);
}

.image-counter {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 5px 8px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 4px;
}

.image-counter i {
    font-size: 10px;
}

.hidden-lightbox-item {
    display: none;
}

.portfolio-info {
    padding: 20px;
    flex-grow: 1;
    display: flex;
    flex-direction: column;
}

.portfolio-title {
    margin: 0 0 15px 0;
    font-size: 18px;
    color: #333;
    font-weight: 600;
}

.portfolio-metadata {
    margin-bottom: 15px;
}

.metadata-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
}

.metadata-item .label {
    color: #666;
    font-weight: 500;
}

.metadata-item .value {
    color: #333;
    font-weight: 600;
}

.portfolio-description {
    font-size: 14px;
    color: #666;
    line-height: 1.4;
    margin-top: auto;
}

@media (max-width: 768px) {
    .portfolio-grid {
        grid-template-columns: 1fr;
        gap: 20px;
    }
    
    .gallery-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .gallery-header h2 {
        font-size: 24px;
    }
}
{% endset %}
{% do assets.addInlineCss(portfolio_styles) %}
{% endblock %}

{% block javascripts %}
{{ parent() }}
{% do assets.addJs('https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/js/glightbox.min.js') %}
{% do assets.addCss('https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/css/glightbox.min.css') %}

{% set gallery_script %}
document.addEventListener('DOMContentLoaded', function() {
    // Initialize lightbox
    const lightbox = GLightbox({
        touchNavigation: true,
        loop: false,
        autoplayVideos: true
    });
    
    // Hide navigation arrows for single image galleries
    lightbox.on('open', function() {
        setTimeout(() => {
            const slider = document.querySelector('.gslider');
            if (slider && slider.children.length <= 1) {
                const prevBtn = document.querySelector('.gprev');
                const nextBtn = document.querySelector('.gnext');
                if (prevBtn) prevBtn.style.display = 'none';
                if (nextBtn) nextBtn.style.display = 'none';
            }
        }, 50);
    });
    
    // Show navigation arrows when closing (for next time)
    lightbox.on('close', function() {
        const prevBtn = document.querySelector('.gprev');
        const nextBtn = document.querySelector('.gnext');
        if (prevBtn) prevBtn.style.display = '';
        if (nextBtn) nextBtn.style.display = '';
    });
});
{% endset %}

{% do assets.addInlineJs(gallery_script) %}
{% endblock %} 