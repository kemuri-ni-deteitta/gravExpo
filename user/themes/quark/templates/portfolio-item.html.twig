{% extends 'partials/base.html.twig' %}

{% block content %}
{% set grid_size = theme_var('grid-size') %}

<section class="section portfolio-item">
    <section class="container {{ grid_size }}">
        <div class="columns">
            <div class="column col-12">
                <div class="content">
                    {{ content|raw }}
                </div>
                
                {# Project Metadata #}
                {% if page.header.stand_type or page.header.construction_area or page.header.exhibition_name or page.header.company_name or page.header.project_year %}
                <div class="project-metadata">
                    <h2>Информация о проекте</h2>
                    <div class="metadata-grid">
                        {% if page.header.stand_type %}
                            <div class="metadata-item">
                                <span class="label">Тип стенда:</span>
                                <span class="value stand-type-{{ page.header.stand_type }}">
                                    {% if page.header.stand_type == 'typovye' %}Типовой
                                    {% elseif page.header.stand_type == 'nestandart' %}Нестандартный
                                    {% elseif page.header.stand_type == 'ekskluziv' %}Эксклюзивный
                                    {% else %}{{ page.header.stand_type }}
                                    {% endif %}
                                </span>
                            </div>
                        {% endif %}
                        
                        {% if page.header.construction_area %}
                            <div class="metadata-item">
                                <span class="label">Площадь застройки:</span>
                                <span class="value">{{ page.header.construction_area }}</span>
                            </div>
                        {% endif %}
                        
                        {% if page.header.exhibition_name %}
                            <div class="metadata-item">
                                <span class="label">Название выставки:</span>
                                <span class="value">{{ page.header.exhibition_name }}</span>
                            </div>
                        {% endif %}
                        
                        {% if page.header.company_name %}
                            <div class="metadata-item">
                                <span class="label">Название компании:</span>
                                <span class="value">{{ page.header.company_name }}</span>
                            </div>
                        {% endif %}
                        
                        {% if page.header.project_year %}
                            <div class="metadata-item">
                                <span class="label">Год проекта:</span>
                                <span class="value">{{ page.header.project_year }}</span>
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {# Project Gallery #}
                {% if page.header.gallery %}
                <div class="gallery-section">
                    <h2>Фотографии проекта</h2>
                    
                    {# Gallery display settings #}
                    {% set display_type = page.header.gallery_display ?: 'grid' %}
                    {% set images_per_row = page.header.images_per_row ?: 3 %}
                    {% set show_captions = page.header.show_captions is defined ? page.header.show_captions : true %}
                    
                    <div class="lightbox-gallery gallery-{{ display_type }} columns-{{ images_per_row }}">
                        <div class="lightbox-gallery__columns">
                            {% set gallery_id = md5(page.url) %}
                            {% set image_counter = 0 %}
                            {% for item in page.header.gallery %}
                                {% set item_image = null %}
                                
                                {# Check for uploaded image first #}
                                {% if item.image_upload %}
                                    {% for filepath, filedata in item.image_upload %}
                                        {% if not item_image and filedata.name %}
                                            {% set item_image = page.media[filedata.name] %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                
                                {# If no uploaded image, check for image_name #}
                                {% if not item_image and item.image_name %}
                                    {% set item_image = page.media[item.image_name] %}
                                {% endif %}
                                
                                {# Fallback to old image field #}
                                {% if not item_image and item.image %}
                                    {% set item_image = page.media[item.image] %}
                                {% endif %}
                                
                                {% if item_image %}
                                    {% set image_counter = image_counter + 1 %}
                                    {% set title = item.title ? item.title : ('Фото ' ~ image_counter) %}
                                    {% set desc = item.desc ? item.desc : '' %}
                                    {% set alt_text = item.alt_text ? item.alt_text : title %}
                                    {% set thumb_width = 400 %}
                                    {% set thumb_height = 300 %}
                                    
                                    <div class="lightbox-gallery__column">
                                        <div class="gallery-item {{ item.is_main ? 'main-image' : '' }}">
                                            <a href="{{ item_image.url }}" 
                                               class="glightbox" 
                                               data-gallery="gallery-{{ gallery_id }}"
                                               data-title="{{ title }}"
                                               data-description="{{ desc }}">
                                                <img src="{{ item_image.cropZoom(thumb_width, thumb_height).url }}" 
                                                     alt="{{ alt_text }}" 
                                                     title="{{ title }}"
                                                     style="width: 100%; height: auto; border-radius: 5px;">
                                            </a>
                                            
                                            {% if item.is_main %}
                                                <div class="main-image-badge">Главное фото</div>
                                            {% endif %}
                                            
                                            {% if show_captions and title %}
                                                <div class="gallery-item-title">{{ title }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    
                    {% if image_counter > 0 %}
                        <div class="gallery-info">
                            <p><strong>Всего фотографий:</strong> {{ image_counter }}</p>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
                
                {# Back to Portfolio link #}
                <div class="back-to-portfolio">
                    <a href="/portfolio" class="btn btn-primary">← Вернуться к портфолио</a>
                </div>
            </div>
        </div>
    </section>
</section>
{% endblock %}

{% block stylesheets %}
{{ parent() }}
{% set portfolio_item_styles %}
.project-metadata {
    margin: 30px 0;
    padding: 25px;
    background: #f8f9fa;
    border-radius: 10px;
}

.project-metadata h2 {
    margin-bottom: 20px;
    color: #333;
    font-size: 22px;
}

.metadata-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
}

.metadata-item {
    display: flex;
    flex-direction: column;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.metadata-item .label {
    color: #666;
    font-weight: 500;
    font-size: 14px;
    margin-bottom: 5px;
}

.metadata-item .value {
    color: #333;
    font-weight: 600;
    font-size: 16px;
}

.stand-type-typovye {
    color: #28a745;
}

.stand-type-nestandart {
    color: #ffc107;
}

.stand-type-ekskluziv {
    color: #dc3545;
}

.gallery-section {
    margin: 30px 0;
}

.gallery-section h2 {
    margin-bottom: 20px;
    color: #333;
    font-size: 22px;
}

.lightbox-gallery {
    margin: 30px 0;
}

.lightbox-gallery .lightbox-gallery__columns {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -10px;
}

.lightbox-gallery .lightbox-gallery__column {
    width: 50%;
    padding: 0 10px;
    margin-bottom: 20px;
}

.gallery-item {
    position: relative;
    overflow: hidden;
    border-radius: 5px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.gallery-item:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

.gallery-item img {
    display: block;
    width: 100%;
    height: auto;
    transition: transform 0.3s ease;
}

.gallery-item:hover img {
    transform: scale(1.05);
}

.gallery-item-title {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 10px;
    font-size: 14px;
    text-align: center;
}

.back-to-portfolio {
    margin-top: 40px;
    text-align: center;
}

.btn {
    display: inline-block;
    padding: 12px 24px;
    background: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 25px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn:hover {
    background: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,123,255,0.3);
}

@media only screen and (min-width: 600px) {
    .lightbox-gallery .lightbox-gallery__column {
        width: calc(100% / 3);
    }
}

@media only screen and (min-width: 1000px) {
    .lightbox-gallery .lightbox-gallery__column {
        width: 25%;
    }
}

@media (max-width: 768px) {
    .metadata-grid {
        grid-template-columns: 1fr;
    }
    
    .lightbox-gallery .lightbox-gallery__column {
    width: 100%;
}

.gallery-grid .lightbox-gallery__columns {
    display: grid;
    gap: 20px;
}

.gallery-grid.columns-2 .lightbox-gallery__columns {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}

.gallery-grid.columns-3 .lightbox-gallery__columns {
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
}

.gallery-grid.columns-4 .lightbox-gallery__columns {
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
}

.gallery-slider .lightbox-gallery__columns {
    display: flex;
    overflow-x: auto;
    gap: 20px;
    padding-bottom: 10px;
}

.gallery-slider .lightbox-gallery__column {
    flex: 0 0 300px;
}

.gallery-masonry .lightbox-gallery__columns {
    columns: auto;
    column-gap: 20px;
}

.gallery-masonry .lightbox-gallery__column {
    width: 100%;
    break-inside: avoid;
    margin-bottom: 20px;
}

.gallery-list .lightbox-gallery__columns {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.gallery-list .lightbox-gallery__column {
    width: 100%;
}

.gallery-list .gallery-item {
    display: flex;
    align-items: center;
    gap: 20px;
}

.gallery-list .gallery-item img {
    width: 200px;
    height: auto;
    flex-shrink: 0;
}

.gallery-list .gallery-item-title {
    position: static;
    background: none;
    color: #333;
    padding: 0;
    font-size: 16px;
}

.gallery-item.main-image {
    border: 3px solid #28a745;
    border-radius: 8px;
}

.gallery-info {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    text-align: center;
}

.gallery-info p {
    margin: 0;
    color: #666;
}
}
{% endset %}

{% do assets.addInlineCss(portfolio_item_styles) %}
{% endblock %}

{% block javascripts %}
{{ parent() }}
{% do assets.addJs('https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/js/glightbox.min.js') %}
{% do assets.addCss('https://cdn.jsdelivr.net/npm/glightbox@3.2.0/dist/css/glightbox.min.css') %}

{% set gallery_script %}
document.addEventListener('DOMContentLoaded', function() {
    const lightbox = GLightbox({
        touchNavigation: true,
        loop: true,
        autoplayVideos: true
    });
});
{% endset %}

{% do assets.addInlineJs(gallery_script) %}
{% endblock %} 